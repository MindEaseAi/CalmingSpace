<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Calm Session</title>
<style>
/* Body & background */
body {
  margin: 0;
  font-family: 'Comic Sans MS', cursive, sans-serif;
  background: linear-gradient(to bottom, #a3d8f4, #d0f0fd);
  color: #022c3a;
  overflow: hidden;
  height: 100vh;
}

/* Clouds */
.cloud {
  position: absolute;
  width: 100px;
  height: 60px;
  background: white;
  border-radius: 50%;
  opacity: 0.8;
  animation: floatClouds linear infinite;
}
@keyframes floatClouds {
  0% {transform: translateX(-150px);}
  100% {transform: translateX(110vw);}
}

/* Screens */
.screen {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: opacity 1.5s ease;
}
.hidden {opacity:0; pointer-events:none;}

/* Avatar container */
.avatar {
  width: 120px;
  height: 140px;
  margin-bottom: 20px;
}
.avatar svg {display:block; animation: float 3s ease-in-out infinite;}
@keyframes float {0%,100%{transform:translateY(0);}50%{transform:translateY(-6px);}}

/* Card */
.card {
  background: rgba(255,255,255,0.6);
  padding: 40px;
  border-radius: 25px;
  max-width: 700px;
  text-align: center;
  box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}

/* Headings & button */
h1 {font-weight:400; margin-bottom:15px;}
button {
  padding: 16px 36px; border-radius: 35px; border:none;
  font-size:20px; background:#34d399; color:white; cursor:pointer;
  box-shadow:0 6px 15px rgba(0,0,0,0.2);
  transition: transform 0.2s, box-shadow 0.2s;
}
button:hover {transform:translateY(-2px); box-shadow:0 10px 20px rgba(0,0,0,0.3);}

/* Passage */
.passage {
  margin-top: 30px;
  font-size: 22px;
  line-height:1.8;
  padding: 20px;
  border-radius: 15px;
  transition: background 0.5s;
}
.passage.active {background: rgba(52,211,153,0.3);}

/* Mini-games */
.circle {width:180px;height:180px;border-radius:50%;background:rgba(52,211,153,0.3);animation:breathe 6s ease-in-out infinite;margin:auto;}
@keyframes breathe {0%{transform:scale(0.8);}50%{transform:scale(1.15);}100%{transform:scale(0.8);}}
.focus-dot {width:30px;height:30px;background:#34d399;border-radius:50%;position:absolute;cursor:pointer;}
.reward-star {color:#ffe066;font-size:36px;margin:5px;}
</style>
</head>
<body>

<!-- Clouds -->
<div class="cloud" style="top:10%; animation-duration:60s;"></div>
<div class="cloud" style="top:25%; animation-duration:80s;"></div>
<div class="cloud" style="top:45%; animation-duration:100s;"></div>
<div class="cloud" style="top:60%; animation-duration:90s;"></div>

<!-- Start Screen -->
<div id="startScreen" class="screen">
  <div class="avatar">
    <svg viewBox="0 0 100 140" width="100" height="140">
      <ellipse cx="50" cy="110" rx="25" ry="30" fill="#34d399"/>
      <circle cx="50" cy="50" r="30" fill="#fff"/>
      <circle cx="40" cy="45" r="5" fill="#022c3a"/>
      <circle cx="60" cy="45" r="5" fill="#022c3a"/>
      <path d="M40 60 Q50 70 60 60" stroke="#022c3a" stroke-width="2" fill="none"/>
    </svg>
  </div>
  <h1>Welcome</h1>
  <p>I’ll stay with you. Let’s begin calmly.</p>
  <button onclick="startSession()">Start Session</button>
</div>

<!-- Reading Screen -->
<div id="readingScreen" class="screen hidden">
  <div class="avatar">
    <svg viewBox="0 0 100 140" width="100" height="140">
      <ellipse cx="50" cy="110" rx="25" ry="30" fill="#34d399"/>
      <circle cx="50" cy="50" r="30" fill="#fff"/>
      <circle cx="40" cy="45" r="5" fill="#022c3a"/>
      <circle cx="60" cy="45" r="5" fill="#022c3a"/>
      <path d="M40 60 Q50 70 60 60" stroke="#022c3a" stroke-width="2" fill="none"/>
    </svg>
  </div>
  <div class="card">
    <h1>Read this for me</h1>
    <div id="passage" class="passage"></div>
    <p style="opacity:0.7;margin-top:20px;">Speak gently. Words glow when I hear you.</p>
  </div>
</div>

<!-- Game Screen -->
<div id="gameScreen" class="screen hidden">
  <div class="avatar">
    <svg viewBox="0 0 100 140" width="100" height="140">
      <ellipse cx="50" cy="110" rx="25" ry="30" fill="#34d399"/>
      <circle cx="50" cy="50" r="30" fill="#fff"/>
      <circle cx="40" cy="45" r="5" fill="#022c3a"/>
      <circle cx="60" cy="45" r="5" fill="#022c3a"/>
      <path d="M40 60 Q50 70 60 60" stroke="#022c3a" stroke-width="2" fill="none"/>
    </svg>
  </div>
  <div class="card">
    <h1 id="gameTitle">Breathe with me</h1>
    <div id="gameArea"></div>
    <p id="gameHint" style="opacity:0.7;margin-top:20px;"></p>
    <div id="rewards"></div>
  </div>
</div>

<script>
// === PASSAGES & REWARDS ===
const passages = [
  "Take a slow breath in. Let your chest expand gently. Feel your body relax.",
  "Nothing is expected now. Each word can be slow, quiet, and soothing.",
  "Pause if needed. Your voice guides your calm. You are safe."
];

let voiceTimer = 0;
let currentGame = 0;
let audioCtx, ambientGain;

// === AMBIENT MUSIC ===
function startAmbient() {
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  ambientGain = audioCtx.createGain();
  ambientGain.gain.value = 0.15;
  ambientGain.connect(audioCtx.destination);

  for(let i=0;i<3;i++){
    const osc = audioCtx.createOscillator();
    osc.type = "sine";
    osc.frequency.value = 60 + Math.random()*80;
    const gain = audioCtx.createGain();
    gain.gain.value = 0.05 + Math.random()*0.05;
    osc.connect(gain);
    gain.connect(ambientGain);
    osc.start();
    osc.stop(audioCtx.currentTime+300);
  }
}

// === SESSION FLOW ===
function startSession() {
  startAmbient(); // starts after user click
  document.getElementById("startScreen").classList.add("hidden");
  setTimeout(()=>{document.getElementById("readingScreen").classList.remove("hidden"); beginReading();},1500);
}

function beginReading() {
  const passage = document.getElementById("passage");
  passage.textContent = passages[Math.floor(Math.random()*passages.length)];
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    const analyser = audioCtx.createAnalyser();
    const mic = audioCtx.createMediaStreamSource(stream);
    mic.connect(analyser);
    analyser.fftSize = 256;
    const data = new Uint8Array(analyser.frequencyBinCount);
    function listen(){
      analyser.getByteFrequencyData(data);
      const volume = data.reduce((a,b)=>a+b)/data.length;
      if(volume>20){passage.classList.add("active"); voiceTimer++;}
      else{passage.classList.remove("active");}
      if(voiceTimer>200){transitionToGames(); return;}
      requestAnimationFrame(listen);
    }
    listen();
  });
}

function transitionToGames() {
  document.getElementById("readingScreen").classList.add("hidden");
  setTimeout(()=>{document.getElementById("gameScreen").classList.remove("hidden"); startGame();},1500);
}

// === MINI-GAMES & REWARDS ===
function startGame(){
  const gameArea=document.getElementById("gameArea");
  const title=document.getElementById("gameTitle");
  const hint=document.getElementById("gameHint");
  const rewards=document.getElementById("rewards");
  gameArea.innerHTML="";

  if(currentGame===0){
    title.textContent="Breathe with me";
    hint.textContent="In as it grows, out as it shrinks.";
    const circle=document.createElement("div"); circle.className="circle"; gameArea.appendChild(circle);
    setTimeout(()=>{giveReward(); currentGame++; startGame();},12000);
  } else {
    title.textContent="Slow Focus";
    hint.textContent="Click the dot gently when it appears.";
    spawnDot();
  }
}

function spawnDot(){
  const dot=document.createElement("div");
  dot.className="focus-dot";
  dot.style.left=Math.random()*80+"%";
  dot.style.top=Math.random()*60+"%";
  dot.onclick=()=>{
    dot.remove(); giveReward(); setTimeout(spawnDot,1200);
  };
  document.getElementById("gameArea").appendChild(dot);
}

function giveReward(){
  const rewards=document.getElementById("rewards");
  const star=document.createElement("span"); star.className="reward-star"; star.textContent="★";
  rewards.appendChild(star);
}
</script>
</body>
</html>
