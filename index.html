<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Calm Session</title>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: radial-gradient(circle at top, #1b2b34, #0a1116);
  color: white;
  overflow: hidden;
}

.screen {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: opacity 1.5s ease;
}

.hidden {
  opacity: 0;
  pointer-events: none;
}

h1 {
  font-weight: 400;
  letter-spacing: 1px;
}

button {
  padding: 14px 28px;
  border-radius: 30px;
  border: none;
  font-size: 18px;
  background: #7dd3fc;
  color: #022c3a;
  cursor: pointer;
}

.avatar {
  width: 120px;
  height: 120px;
  background: #7dd3fc;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
  animation: float 4s ease-in-out infinite;
}

.avatar::before {
  content: "☺";
  font-size: 48px;
  color: #022c3a;
}

@keyframes float {
  0%,100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.card {
  background: rgba(255,255,255,0.08);
  padding: 30px;
  border-radius: 20px;
  max-width: 600px;
  text-align: center;
  box-shadow: 0 20px 40px rgba(0,0,0,0.4);
}

.passage {
  margin-top: 20px;
  font-size: 20px;
  line-height: 1.6;
  padding: 15px;
  border-radius: 12px;
  transition: background 0.5s;
}

.passage.active {
  background: rgba(0,255,180,0.25);
}

.aurora {
  position: absolute;
  inset: 0;
  background: linear-gradient(120deg, #38bdf8, #34d399, #818cf8);
  opacity: 0.15;
  animation: aurora 14s linear infinite;
  pointer-events: none;
}

@keyframes aurora {
  0% { filter: hue-rotate(0deg); }
  100% { filter: hue-rotate(360deg); }
}

/* Mini games */
.circle {
  width: 160px;
  height: 160px;
  border-radius: 50%;
  background: rgba(125,211,252,0.4);
  animation: breathe 6s ease-in-out infinite;
}

@keyframes breathe {
  0% { transform: scale(0.8); }
  50% { transform: scale(1.1); }
  100% { transform: scale(0.8); }
}

.focus-dot {
  width: 30px;
  height: 30px;
  background: #34d399;
  border-radius: 50%;
  position: absolute;
  cursor: pointer;
}
</style>
</head>

<body>
<div class="aurora"></div>

<!-- START SCREEN -->
<div id="startScreen" class="screen">
  <div class="avatar"></div>
  <h1>Welcome</h1>
  <p>I’ll stay with you. Let’s begin calmly.</p>
  <button onclick="startSession()">Start Session</button>
</div>

<!-- READING SCREEN -->
<div id="readingScreen" class="screen hidden">
  <div class="avatar"></div>
  <div class="card">
    <h1>Read this for me</h1>
    <div id="passage" class="passage"></div>
    <p style="opacity:.7">Speak gently. The words will glow when I hear you.</p>
  </div>
</div>

<!-- MINI GAME SCREEN -->
<div id="gameScreen" class="screen hidden">
  <div class="avatar"></div>
  <div class="card">
    <h1 id="gameTitle">Breathe with me</h1>
    <div id="gameArea"></div>
    <p id="gameHint" style="opacity:.7;margin-top:15px;"></p>
  </div>
</div>

<script>
const passages = [
  "Take a slow breath in. Let the air fill your chest gently. As you speak, allow your body to soften.",
  "Nothing is expected of you right now. Each word can be slow, quiet, and kind.",
  "You are allowed to rest here. Let your voice move at its own calm pace."
];

let voiceTimer = 0;
let currentGame = 0;

function startSession() {
  document.getElementById("startScreen").classList.add("hidden");
  setTimeout(() => {
    document.getElementById("readingScreen").classList.remove("hidden");
    beginReading();
  }, 1500);
}

function beginReading() {
  const passage = document.getElementById("passage");
  passage.textContent = passages[Math.floor(Math.random()*passages.length)];

  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    const ctx = new AudioContext();
    const analyser = ctx.createAnalyser();
    const mic = ctx.createMediaStreamSource(stream);
    mic.connect(analyser);
    analyser.fftSize = 256;

    const data = new Uint8Array(analyser.frequencyBinCount);

    function listen() {
      analyser.getByteFrequencyData(data);
      const volume = data.reduce((a,b)=>a+b)/data.length;

      if (volume > 20) {
        passage.classList.add("active");
        voiceTimer++;
      } else {
        passage.classList.remove("active");
      }

      if (voiceTimer > 200) {
        transitionToGames();
        return;
      }

      requestAnimationFrame(listen);
    }
    listen();
  });
}

function transitionToGames() {
  document.getElementById("readingScreen").classList.add("hidden");
  setTimeout(() => {
    document.getElementById("gameScreen").classList.remove("hidden");
    startGame();
  }, 1500);
}

function startGame() {
  const gameArea = document.getElementById("gameArea");
  const title = document.getElementById("gameTitle");
  const hint = document.getElementById("gameHint");
  gameArea.innerHTML = "";

  if (currentGame === 0) {
    title.textContent = "Breathe with me";
    hint.textContent = "In as it grows. Out as it shrinks.";
    const circle = document.createElement("div");
    circle.className = "circle";
    gameArea.appendChild(circle);

    setTimeout(() => {
      currentGame++;
      startGame();
    }, 12000);

  } else {
    title.textContent = "Slow Focus";
    hint.textContent = "Click the dot gently when it appears.";
    spawnDot();
  }
}

function spawnDot() {
  const dot = document.createElement("div");
  dot.className = "focus-dot";
  dot.style.left = Math.random()*80 + "%";
  dot.style.top = Math.random()*60 + "%";
  dot.onclick = () => {
    dot.remove();
    setTimeout(spawnDot, 1200);
  };
  document.getElementById("gameArea").appendChild(dot);
}
</script>
</body>
</html>
