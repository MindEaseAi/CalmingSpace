<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Calm Session</title>
<style>
/* Body & Background */
body {
  margin: 0;
  font-family: 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg,#1f2a38,#0f131a);
  color: #f0f0f0;
  overflow: hidden;
}

/* Screens */
.screen {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: opacity 1.5s ease;
}

.hidden {
  opacity: 0;
  pointer-events: none;
}

/* Avatar */
.avatar {
  width: 180px;
  height: 180px;
  background: radial-gradient(circle at 30% 30%, #7dd3fc, #34d399);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 30px;
  animation: float 5s ease-in-out infinite;
  box-shadow: 0 0 50px rgba(125,211,252,0.4);
}

.avatar::before {
  content: "☺";
  font-size: 64px;
  color: #022c3a;
}

@keyframes float {
  0%,100% { transform: translateY(0); }
  50% { transform: translateY(-12px); }
}

/* Headings & buttons */
h1 {
  font-weight: 400;
  letter-spacing: 1px;
  margin-bottom: 15px;
}

button {
  padding: 16px 36px;
  border-radius: 35px;
  border: none;
  font-size: 20px;
  background: #7dd3fc;
  color: #022c3a;
  cursor: pointer;
  box-shadow: 0 6px 15px rgba(0,0,0,0.2);
  transition: transform 0.2s, box-shadow 0.2s;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}

/* Card */
.card {
  background: rgba(255,255,255,0.05);
  padding: 40px;
  border-radius: 25px;
  max-width: 700px;
  text-align: center;
  box-shadow: 0 25px 50px rgba(0,0,0,0.4);
}

/* Passage */
.passage {
  margin-top: 30px;
  font-size: 22px;
  line-height: 1.8;
  padding: 20px;
  border-radius: 15px;
  transition: background 0.5s;
}

.passage.active {
  background: rgba(0,255,180,0.3);
}

/* Aurora Background */
.aurora {
  position: absolute;
  inset: 0;
  background: linear-gradient(120deg, #38bdf8, #34d399, #818cf8);
  opacity: 0.12;
  animation: aurora 14s linear infinite;
  pointer-events: none;
}

@keyframes aurora {
  0% { filter: hue-rotate(0deg); }
  100% { filter: hue-rotate(360deg); }
}

/* Mini-games */
.circle {
  width: 200px;
  height: 200px;
  border-radius: 50%;
  background: rgba(125,211,252,0.35);
  animation: breathe 6s ease-in-out infinite;
}

@keyframes breathe {
  0% { transform: scale(0.8); }
  50% { transform: scale(1.15); }
  100% { transform: scale(0.8); }
}

.focus-dot {
  width: 35px;
  height: 35px;
  background: #34d399;
  border-radius: 50%;
  position: absolute;
  cursor: pointer;
}
</style>
</head>
<body>

<div class="aurora"></div>

<!-- Start Screen -->
<div id="startScreen" class="screen">
  <div class="avatar"></div>
  <h1>Welcome</h1>
  <p>I’ll stay with you. Let’s begin calmly.</p>
  <button onclick="startSession()">Start Session</button>
</div>

<!-- Reading Screen -->
<div id="readingScreen" class="screen hidden">
  <div class="avatar"></div>
  <div class="card">
    <h1>Read this for me</h1>
    <div id="passage" class="passage"></div>
    <p style="opacity:0.7;margin-top:20px;">
      Speak gently. The words will glow when I hear you.
    </p>
  </div>
</div>

<!-- Game Screen -->
<div id="gameScreen" class="screen hidden">
  <div class="avatar"></div>
  <div class="card">
    <h1 id="gameTitle">Breathe with me</h1>
    <div id="gameArea"></div>
    <p id="gameHint" style="opacity:0.7;margin-top:20px;"></p>
  </div>
</div>

<script>
const passages = [
  "Take a slow breath in. Let your chest expand gently. As you read aloud, feel your body relax.",
  "Nothing is expected of you now. Each word can be slow, quiet, and soothing.",
  "Pause if needed. Your voice guides your calm. You are safe in this moment."
];

let voiceTimer = 0;
let currentGame = 0;

function startSession() {
  document.getElementById("startScreen").classList.add("hidden");
  setTimeout(() => {
    document.getElementById("readingScreen").classList.remove("hidden");
    beginReading();
  }, 1500);
}

function beginReading() {
  const passage = document.getElementById("passage");
  passage.textContent = passages[Math.floor(Math.random()*passages.length)];

  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    const ctx = new AudioContext();
    const analyser = ctx.createAnalyser();
    const mic = ctx.createMediaStreamSource(stream);
    mic.connect(analyser);
    analyser.fftSize = 256;

    const data = new Uint8Array(analyser.frequencyBinCount);

    function listen() {
      analyser.getByteFrequencyData(data);
      const volume = data.reduce((a,b)=>a+b)/data.length;

      if (volume > 20) {
        passage.classList.add("active");
        voiceTimer++;
      } else {
        passage.classList.remove("active");
      }

      if (voiceTimer > 200) {
        transitionToGames();
        return;
      }

      requestAnimationFrame(listen);
    }
    listen();
  });
}

function transitionToGames() {
  document.getElementById("readingScreen").classList.add("hidden");
  setTimeout(() => {
    document.getElementById("gameScreen").classList.remove("hidden");
    startGame();
  }, 1500);
}

function startGame() {
  const gameArea = document.getElementById("gameArea");
  const title = document.getElementById("gameTitle");
  const hint = document.getElementById("gameHint");
  gameArea.innerHTML = "";

  if (currentGame === 0) {
    title.textContent = "Breathe with me";
    hint.textContent = "In as it grows, out as it shrinks.";
    const circle = document.createElement("div");
    circle.className = "circle";
    gameArea.appendChild(circle);

    setTimeout(() => {
      currentGame++;
      startGame();
    }, 12000);
  } else {
    title.textContent = "Slow Focus";
    hint.textContent = "Click the dot gently when it appears.";
    spawnDot();
  }
}

function spawnDot() {
  const dot = document.createElement("div");
  dot.className = "focus-dot";
  dot.style.left = Math.random()*80 + "%";
  dot.style.top = Math.random()*60 + "%";
  dot.onclick = () => {
    dot.remove();
    setTimeout(spawnDot, 1200);
  };
  document.getElementById("gameArea").appendChild(dot);
}
</script>
</body>
</html>
