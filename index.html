<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Calm Space</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #0b1020;
  font-family: system-ui, sans-serif;
  color: white;
  overflow: hidden;
}

#aurora {
  position: fixed;
  inset: 0;
  background: linear-gradient(120deg,#5faaff55,#8affc155,#c58cff55);
  filter: blur(90px);
  animation: aurora 30s linear infinite;
  z-index: 0;
}
@keyframes aurora {
  0% { transform: translateX(-40%); }
  50% { transform: translateX(40%); }
  100% { transform: translateX(-40%); }
}

.container {
  position: relative;
  z-index: 2;
  max-width: 560px;
  margin: 6vh auto;
  text-align: center;
  padding: 20px;
}

/* Avatar */
.avatar {
  width: 140px;
  height: 140px;
  margin: 0 auto 20px;
  border-radius: 50%;
  background: radial-gradient(circle,#d7e7ff,#7b9cff);
  display: flex;
  align-items: center;
  justify-content: center;
  animation: float 6s ease-in-out infinite;
  box-shadow: 0 0 40px rgba(140,180,255,0.4);
}

.face {
  width: 64px;
  height: 44px;
  position: relative;
}

.eye {
  width: 10px;
  height: 10px;
  background: #000;
  border-radius: 50%;
  position: absolute;
  top: 0;
  animation: blink 6s infinite;
}
.eye.left { left: 6px; }
.eye.right { right: 6px; }

.mouth {
  position: absolute;
  bottom: 0;
  left: 50%;
  width: 30px;
  height: 14px;
  border-radius: 0 0 20px 20px;
  border: 3px solid #000;
  border-top: none;
  transform: translateX(-50%);
}

@keyframes blink {
  0%,96%,100%{transform:scaleY(1)}
  97%{transform:scaleY(0.1)}
}

@keyframes float {
  0%{transform:translateY(0)}
  50%{transform:translateY(-16px)}
  100%{transform:translateY(0)}
}

button {
  padding: 14px 38px;
  border-radius: 30px;
  border: none;
  background: #7faaff;
  color: #000;
  font-size: 16px;
  cursor: pointer;
}

#passage {
  margin-top: 25px;
  font-size: 18px;
  line-height: 1.7;
}

#mic {
  width: 90px;
  height: 90px;
  margin: 20px auto;
  border-radius: 50%;
  background: rgba(140,255,200,0.7);
  box-shadow: 0 0 40px rgba(140,255,200,0.7);
  transition: transform 0.1s, box-shadow 0.1s;
}

#status {
  font-size: 14px;
  opacity: 0.7;
}
</style>
</head>

<body>

<div id="aurora"></div>

<div class="container">
  <div class="avatar" id="avatar">
    <div class="face">
      <div class="eye left"></div>
      <div class="eye right"></div>
      <div class="mouth"></div>
    </div>
  </div>

  <h1>Calm Space</h1>
  <p>Read gently. Your voice guides the calm.</p>

  <button onclick="startSession()">Begin</button>

  <div id="passage"></div>
  <div id="mic"></div>
  <div id="status"></div>
</div>

<script>
let audioCtx, analyser, micSource, ambientNodes = [];
let passageIndex = 0;

const passages = [
  "Breathe in slowly. Let your voice be soft and unhurried.",
  "There is no rush. Each word can float gently forward.",
  "You are safe in this moment. Nothing else needs attention.",
  "Allow pauses. Silence is part of calm.",
  "Stay here. Your voice is steady and enough."
];

function startSession() {
  startAmbient();
  startMic();
  passageIndex = 0;
  showPassage();
}

/* GENERATED AMBIENT */
function startAmbient() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  const noiseBuf = audioCtx.createBuffer(1, audioCtx.sampleRate * 2, audioCtx.sampleRate);
  const data = noiseBuf.getChannelData(0);
  for (let i = 0; i < data.length; i++) data[i] = (Math.random()*2-1)*0.025;

  const noise = audioCtx.createBufferSource();
  noise.buffer = noiseBuf;
  noise.loop = true;

  const osc = audioCtx.createOscillator();
  osc.type = "sine";
  osc.frequency.value = 80 + Math.random()*120;

  const filter = audioCtx.createBiquadFilter();
  filter.type = "lowpass";
  filter.frequency.value = 400 + Math.random()*600;

  const gain = audioCtx.createGain();
  gain.gain.value = 0.25;

  noise.connect(filter);
  osc.connect(filter);
  filter.connect(gain);
  gain.connect(audioCtx.destination);

  noise.start();
  osc.start();
}

/* MICROPHONE + VISUAL REACTION */
async function startMic() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    micSource = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;

    micSource.connect(analyser);
    document.getElementById("status").innerText =
      "Microphone active. Read aloud naturally.";

    visualizeMic();
  } catch {
    document.getElementById("status").innerText =
      "Microphone access blocked.";
  }
}

function visualizeMic() {
  const data = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(data);

  const volume = data.reduce((a,b)=>a+b)/data.length;
  const scale = 1 + volume / 300;

  document.getElementById("mic").style.transform =
    `scale(${scale})`;
  document.getElementById("mic").style.boxShadow =
    `0 0 ${30+volume}px rgba(140,255,200,0.8)`;

  document.getElementById("avatar").style.transform =
    `scale(${1 + volume/600})`;

  if (volume > 25) advancePassage();

  requestAnimationFrame(visualizeMic);
}

/* PASSAGE FLOW */
function showPassage() {
  document.getElementById("passage").innerText = passages[passageIndex];
}

let lastAdvance = 0;
function advancePassage() {
  const now = Date.now();
  if (now - lastAdvance < 4000) return;
  lastAdvance = now;

  passageIndex++;
  if (passageIndex < passages.length) {
    showPassage();
  }
}
</script>

</body>
</html>
